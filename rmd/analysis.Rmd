---
title: "Google User Study"
author: ""
date: "`r Sys.Date()`"
output:
  html_document:
    theme: paper
    highlight: kate
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: true
editor_options: 
  chunk_output_type: console
---

<style>
.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus {
  background-color: #00d188;
  border-color: #00d188;
}

body {
  font-family: montserrat;
  color: #444444;
  font-size: 14px;
}

h1 {
  font-weight: bold;
  font-size: 28px;
}

h1.title {
  font-size: 30px;
  color: #00d188;
}

h2 {
  font-size: 24px;
}

h3 {
  font-size: 18px;
}
</style>

#folder structure

+-- 2020-google-user-study.Rproj
+-- plots <-  folder for final and polished charts and maps
+-- proc_data <- folder for all data that has been processed or saved from the raw files 
+-- raw_data <- folder for raw data files
+-- README.md
\-- rmd
    +-- analysis.Rmd <- file for modeling data and polishing charts
    \-- final.Rmd <- final file with polished graphs and results description


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.showtext = TRUE, dpi = 700)

knitr::knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark = ",", small.mark = ",", scientific = F)
})

Sys.setlocale("LC_TIME", "C")
extrafont::loadfonts(device = "win")
```

```{r prep}
## packages
library(tidyverse)
library(tidytext)
library(colorspace)
library(sf)
library(maps)
library(albersusa) # remotes::install_github("hrbrmstr/albersusa")
library(rgeocodio) # remotes::install_github("hrbrmstr/rgeocodio")
library(geojsonio)
library(rgeos)
library(ggwordcloud)
library(patchwork)
library(pdftools)
library(showtext)

## save plots?
save <- TRUE
#save <- FALSE

## quality of png's
dpi <- 750

## font
extrafont::loadfonts(device = "win", quiet = TRUE)
font_add_google("Montserrat", "Montserrat")
# font_add_google("Overpass", "Overpass")
# font_add_google("Overpass Mono", "Overpass Mono")

## theme updates
#theme_set(ggthemes::theme_clean(base_size = 15))
theme_set(ggthemes::theme_clean(base_size = 15, base_family = "Montserrat"))


theme_update(plot.margin = margin(30, 30, 30, 30),
             plot.background = element_rect(color = "white",
                                            fill = "white"),
             plot.title = element_text(size = 22,
                                       face = "bold",
                                       lineheight = 1.05,
                                       hjust = .5,
                                       margin = margin(10, 0, 25, 0)),
             plot.title.position = "plot",
             plot.caption = element_text(color = "grey40",
                                         size = 9,
                                         margin = margin(20, 0, -20, 0)),
             plot.caption.position = "plot",
             axis.line.x = element_line(color = "black",
                                        size = .8),
             axis.line.y = element_line(color = "black",
                                        size = .8),
             axis.title.x = element_text(size = 16,
                                         face = "bold",
                                         margin = margin(t = 20)),
             axis.title.y = element_text(size = 16,
                                         face = "bold",
                                         margin = margin(r = 20)),
             axis.text = element_text(size = 11,
                                      color = "black",
                                      face = "bold"),
             axis.text.x = element_text(margin = margin(t = 10)),
             axis.text.y = element_text(margin = margin(r = 10)),
             axis.ticks = element_blank(),
             panel.grid.major.x = element_line(size = .6,
                                               color = "#eaeaea",
                                               linetype = "solid"),
             panel.grid.major.y = element_line(size = .6,
                                               color = "#eaeaea",
                                               linetype = "solid"),
             panel.grid.minor.x = element_line(size = .6,
                                               color = "#eaeaea",
                                               linetype = "solid"),
             panel.grid.minor.y = element_blank(),
             panel.spacing.x = unit(4, "lines"),
             panel.spacing.y = unit(2, "lines"),
             legend.position = "top",
             legend.title = element_text(family = "Montserrat",
                                         color = "black",
                                         size = 14,
                                         margin = margin(5, 0, 5, 0)),
             legend.text = element_text(family = "Montserrat",
                                        color = "black",
                                        size = 11,
                                        margin = margin(4.5, 4.5, 4.5, 4.5)),
             legend.background = element_rect(fill = NA,
                                              color = NA),
             legend.key = element_rect(color = NA, fill = NA),
             #legend.key.width = unit(5, "lines"),
             #legend.spacing.x = unit(.05, "pt"),
             #legend.spacing.y = unit(.55, "pt"),
             #legend.margin = margin(0, 0, 10, 0),
             strip.text = element_text(face = "bold",
                                       margin = margin(b = 10)))

## theme settings for flipped plots
theme_flip <-
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_line(size = .6,
                                          color = "#eaeaea"))

## theme settings for maps
theme_map <- 
  theme_void(base_family = "Montserrat") +
  theme(legend.direction = "horizontal",
        legend.box = "horizontal",
        legend.margin = margin(10, 10, 10, 10),
        legend.title = element_text(size = 17, 
                                    face = "bold"),
        legend.text = element_text(color = "grey33",
                                   size = 12),
        plot.margin = margin(15, 5, 15, 5),
        plot.title = element_text(face = "bold",
                                  size = 20,
                                  hjust = .5,
                                  margin = margin(30, 0, 10, 0)),
        plot.subtitle = element_text(face = "bold",
                                     color = "grey33",
                                     size = 17,
                                     hjust = .5,
                                     margin = margin(10, 0, -30, 0)),
        plot.caption = element_text(size = 14,
                                    color = "grey33",
                                    hjust = .97,
                                    margin = margin(-30, 0, 0, 0)))

## numeric format for labels
num_format <- scales::format_format(big.mark = ",", small.mark = ",", scientific = F)

## main color backlinko
bl_col <- "#00d188"

## colors + labels for interval stripes
int_cols <- c("#bce2d5", "#79d8b6", bl_col, "#009f66", "#006c45", "#003925")
int_perc <- c("100%", "95%", "75%", "50%", "25%", "5%")

## colors for degrees (Bachelors, Massters, Doctorate in reverse order)
cols_degree <- c("#e64500", "#FFCC00", darken(bl_col, .1))

## gradient colors for position
colfunc <- colorRampPalette(c(bl_col, "#bce2d5"))
pos_cols <- colfunc(10)
```

# 0. Data

## load

```{r}
full_data <- readRDS(here::here("proc_data/clean_data.RDS"))
```


## define descriptions for the different questions

```{r}
# Commercial_1_pyhsical: find a car phone holder (assumption: Google shopping results)
# Commercial_2_service: find a credit card (assumptions: affiliate articles)
# Local: find a car accident lawyer (assumptions: ads)
# Informational_1: find how to cut your own hair (assumptions: videos)
# Informational_2: find how to treat back pain (assumptions: in-depth articles)
# Transactional: find supplements that may help with lower back pain
# Commercial_3_service: buy groceries online in your local area
question_descs <- c(
  Q1_Commercial_1_pyhsical = "find a car phone holder",
  Q2_Commercial_2_service = "find a credit card",
  Q3_Local = "find a car accident lawyer",
  Q4_Informational_1_video = "find how to cut your own hair",
  Q5_Informational_2_indeepth = "find how to treat back pain",
  Q6_transactional = "find supplements to treat back pain",
  Q7_Commercial_3_service = "buy groceries online"
)
```


# 1. Raw analysis

We go through all items and drive out key insights. First w define the plotting
functions that we'll use

```{r}
plots <- list()

save_plot <- function(plot, item) {
  if (save)
    #ggsave(here::here("plots", paste0(make.names(item), ".pdf")), plots[[item]], width = 12, height = 11, device = cairo_pdf)
    ggsave(here::here("plots", paste0(make.names(item), ".png")), plot, width = 12, height = 11)
}

lollipop_chart <- function(full_data, item, title, xlab, nudge_x = 0, percent = TRUE, fun = ~mean(., na.rm = TRUE), digits = 1) {
  summary_by_q <-
    full_data %>%
    mutate(question = question_descs[question]) %>%
    group_by(question) %>%
    summarize_at(item, fun) %>%
    mutate(group = "a")
  
  summary_overall <-
    full_data %>%
    summarize_at(item, fun) %>%
    mutate(question = "overall", group = "b")
  
  summary_all <- 
    bind_rows(summary_by_q, summary_overall) %>%
    arrange_at(item) %>%
    mutate(question = factor(question, question)) # sort factors
  
  ggplot(summary_all) +
    geom_segment(aes(y= question, yend = question, x = 0, xend = !!sym(item),
                     color = group), size = 2) + 
    geom_point(aes(x = !!sym(item), y = question, color = group), size = 7) +
    geom_text(data = summary_overall,
              aes(!!sym(item), question, label = if(percent) scales::percent(!!sym(item), digits) else round(!!sym(item), digits)), color = "black", 
              hjust = 0, nudge_x = nudge_x) +
    labs(x = xlab, y = "") +
    scale_color_manual(values = c("lightgreen","lightblue")) +
    {if (percent) scale_x_continuous(labels = function(x) scales::percent(x, digits))} +
    ggtitle(title) +
    theme(legend.position = "none")
}
  
quantile_chart <- function(full_data, item, title, xlab, ylab, qlab, meanlab, xmax, 
                           nudge_x, digits = 1){
  plot_data <- full_data %>%
    group_by_at(item) %>%
    summarize(pct = n()/nrow(.)) %>%
    mutate_at("pct", cumsum) 
  
  x_mean <- mean(full_data[[item]])
  
  mean_data <- tibble(
    x = mean(full_data[[item]]),
    y = approx(plot_data[[item]], plot_data$pct, xout = x_mean)$y,
    lab = sprintf(meanlab, round(x_mean, 1))
  )
  
  q_data = tibble(
    q = quantile(full_data[[item]], c(.25,.5,.75)), 
    x = approx(plot_data$pct, plot_data[[item]], xout = c(.25,.5,.75))$y,
    y = c(.25,.50,.75),
    lab = sprintf(qlab, y*100, q))
  
  plot_data %>%
    ggplot(aes(!!sym(item), pct))  + 
    geom_line() +
    coord_cartesian(xlim = c(0,xmax)) + 
    ggtitle(title) +
    labs(x = xlab, y = ylab) +
    geom_point(aes(x,y), data = q_data, size = 4) +
    geom_point(aes(x,y), data = mean_data, color = "blue", size = 4) +
    geom_text(aes(x,y, label = lab), data = q_data, hjust = 0, nudge_x = nudge_x) +
    geom_text(aes(x,y, label = lab), data = mean_data, hjust = 0, nudge_y = -0.05) +
    scale_y_continuous(labels = function(x) scales::percent(x, digits))
}

bar_chart <- function(full_data, item,title, xlab, ylab, threshold) {
  full_data %>%
  transmute_at(item, ~ifelse(.>= threshold, paste0(threshold, "+"), .)) %>%
  group_by_at(item) %>%
  count() %>%
  ungroup() %>%
  mutate(n = n/sum(n)) %>%
  na.omit() %>%
  ggplot(aes(!!sym(item),n)) +
  geom_col(fill = "lightgreen",color = "darkgreen") +
  geom_text(aes(label = scales::percent(n,1)), vjust = 0, nudge_y = .02) +
  ggtitle(title) +
  scale_y_continuous(labels = function(x) scales::percent(x,1)) +
  labs(x = xlab, y = ylab)
}
```

## 1.1 When typing the search query, did they select one of the suggested searches? (Y/N)

```{r}
item <- "When typing the search query, did they select one of the suggested searches? (Y/N)"

plots[[item]] <- lollipop_chart(
  full_data, item,
  "Suggested searches are used 1 time in 4", "% of users who selected a suggestion",
  nudge_x = .02, fun = ~mean(. != 0, na.rm = TRUE))

save_plot(plots[[item]], item)
```

## 1.2 Seconds to first click (use check time stamping on video)

```{r}
item <- "Seconds to first click (use check time stamping on video)"

# full_data %>%
#   group_by_at(4) %>%
#   summarize(n = n()) %>%
#   ggplot(aes(!!sym(item), n)) +
#   geom_point() +
#   geom_line() +
#   ggtitle("raw chart")

plots[[item]] <- quantile_chart(
  full_data, item,
  "The average user clicks first after 15 seconds",
  "time (seconds)", "% of users who click before time",
  meanlab = "Average: %s sec", qlab = "%s%% click before %s sec",
  xmax = 50, nudge_x = 3)

save_plot(plots[[item]], item)

item2 <- paste0(item,"_2")

plots[[item2]] <- lollipop_chart(
  full_data, item,
  "The average time to first click spans from 10 to 25 seconds", "time (seconds)",
  nudge_x = 1, percent = FALSE)

save_plot(plots[[item2]], item2)
```

## 1.3 Scrolling to the end of the search page

```{r}
item <- "Did they scroll to the end of the Google Search Page (Y/N)?"

plots[[item]] <- lollipop_chart(
  full_data, item,
  "9% of users reach the end of the page,\nbut it depends a lot on the query", 
  "% of users who scrolled to the bottom", nudge_x = .01)
plots[[item]]

save_plot(plots[[item]], item)
```

## 1.4 Times changed/modified search query

```{r}
item <- "Times changed/modified search query"

table(full_data[[6]])

plots[[item]] <-  bar_chart(
  full_data, item,
  "85% of the time, users stick to their first choice of query",
   "number of changes", "% of users", 2)
save_plot(plots[[item]], item)

item2 <- paste0(item,"_2")
plots[[item2]] <- lollipop_chart(
  full_data, item,
  "Percentage of users who modify their query", "", 
  fun = ~mean(. != 0, na.rm = TRUE),
  nudge_x = .02)

save_plot(plots[[item2]], item2)
```

## 1.5 Times searcher clicks a result, then bounces back to the search results page and chooses a different result

```{r}
item <- "Times searcher clicks a result, then bounces back to the search results page and chooses a different result"
table(full_data[[7]])

plots[[item]] <- bar_chart(
  full_data, item,
  "", "number of clicks followed by bounces",  "% of users", 2)

save_plot(plots[[item]], item)

item2 <- paste0(item,"_2")
plots[[item2]] <- lollipop_chart(
  full_data, item,
  "10% to 30% of users bounce at least once", "% of users who bounce at least once", 
  fun = ~mean(. != 0, na.rm = TRUE), nudge_x = .02)

save_plot(plots[[item2]], item2)
```

## 1.6 Number of pages visited

```{r}
item <- "Number of pages visited"
table(full_data[[item]])

plots[[item]] <- 
  bar_chart(
    full_data, item,
    "Most users visit only one page", "number of pages visited", 
    "% of users", threshold = 4)

save_plot(plots[[item]], item)

item2 <- paste0(item,"_2")
plots[[item2]] <- lollipop_chart(
    full_data, item,
    "Average number of visited pages", "", 
    nudge_x = .1,
    percent = FALSE)

save_plot(plots[[item2]], item2)
```

## 1.7 Clicks on organic search results

```{r}
item <- "Clicks on organic search results"
table(full_data[[item]])

plots[[item]] <- bar_chart(
  full_data, item,
  "Clicks on organic search results",
  "number of clicks", "% of users",
  threshold = 3)

save_plot(plots[[item]], item)

item2 <- paste0(item,"_2")
plots[[item2]] <- lollipop_chart(
  full_data, item,
  "Percentage of users who click on organic search results", "", 
  nudge_x = .05,
  percent = TRUE,
  fun = ~mean(. != 0, na.rm = TRUE))

save_plot(plots[[item2]], item2)
```


## 1.8 Clicks on Google AdWords/paid listings

```{r}
item <- "Clicks on Google AdWords/paid listings"
table(full_data[[item]])

plots[[item]] <- bar_chart(
  full_data, item,
  "Clicks on Google AdWords and paid listings",
  "number of clicks", "% of users", 2)

save_plot(plots[[item]], item)

item2 <- paste0(item,"_2")
plots[[item2]] <- lollipop_chart(
  full_data, item,
  "Percentage of users who click on Google AdWords or paid listings", "", 
  nudge_x = .02,
  percent = TRUE,
  fun = ~mean(. != 0, na.rm = TRUE))

save_plot(plots[[item2]], item2)
```


## 1.9 Clicks on video results

```{r}
item <- "Clicks on video results"
table(full_data[[item]])

plots[[item]] <- bar_chart(
  full_data, item,
  "Clicks on video results",  "number of clicks", "% of users", 2)
save_plot(plots[[item]], item)

item2 <- paste0(item,"_2")
plots[[item2]] <- lollipop_chart(
  full_data, item,
  "Users are much more likely to click on video results\nif they look for how to cut one's hair",
  "% of users who click on video results", 
  nudge_x = .02,
  percent = TRUE,
  fun = ~mean(. != 0, na.rm = TRUE))

save_plot(plots[[item2]], item2)
```

## 1.10 Clicks on Google Maps/local listings

```{r}
item <- "Clicks on Google Maps/local listings"
table(full_data[[item]])

plots[[item]] <- bar_chart(
  full_data, item,
  "In 94% of searches, the user won't click on Maps or local listings", "number of clicks", "% of users who click on Maps or local listings", 2)

save_plot(plots[[item]], item)

item2 <- paste0(item,"_2")
plots[[item2]] <- lollipop_chart(
  full_data, item,
  "Users are much more likely to click on Google Maps or local listings\nif they look for a car accident lawyer",
  "% of users who click on Google Maps or local listings", 
  nudge_x = .02,
  percent = TRUE,
  fun = ~mean(. != 0, na.rm = TRUE))

save_plot(plots[[item2]], item2)
```


## 1.11 If clicked on Google Maps/local listing, did they click on one of the first three listings?

No plot here, we'll share the conclusion in text

```{r}
item <- "If clicked on Google Maps/local listing, did they click on one of the first three listings?"
table(full_data[[item]], full_data[["question"]], useNA = "always")

full_data %>%
  group_by(question) %>%
  summarize(clickers = sum(`Clicks on Google Maps/local listings` != 0), first3 = 100*mean(!!sym(item), na.rm = TRUE))

full_data %>%
  summarize(clickers = sum(`Clicks on Google Maps/local listings` != 0), first3 = 100*mean(!!sym(item), na.rm = TRUE))
```

## 1.12 Clicks on Image blocks

We measure how often users click on image blocks and find that they click on them
less than half a percent of the time.

Note to Daniel : probably better not to include this at all

better check that the instruction and measurement were ok because number
is really low

```{r}
item <- "Clicks on Image blocks"
table(full_data[[item]], useNA = "always")
scales::percent(mean(full_data[[item]] != 0, na.rm = TRUE))
```

## 1.13 Clicks on Google Shopping results

```{r}
item <- "Clicks on Google Shopping results"
table(full_data[[item]], useNA = "always")

plots[[item]] <- lollipop_chart(
  full_data, item, 
  "Users are more likely to click on Google Shopping results\nif they look for supplements to treat back pain", "% of users who click on Google Shopping results",
  fun = ~ mean(.!=0, na.rm =TRUE), nudge_x = .01)

save_plot(plots[[item]], item)
```


## 1.14 Clicks "people also ask" box

```{r}
item <- "Clicks \"people also ask\" box"
table(full_data[[item]], useNA = "always")

plots[[item]] <- lollipop_chart(
  full_data, item, 
  "Users are more likely to click on \"people also ask\" box\nif they look for supplements to treat back pain", "% of users who click on \"people also ask\" box",
  fun = ~ mean(.!=0, na.rm =TRUE),
  nudge_x = .01)

save_plot(plots[[item]], item)
```

## 1.15 Clicks to 2nd+ Google page

```{r}
item <- "Clicks to 2nd+ Google page"
table(full_data[[item]], useNA = "always")

plots[[item]] <- lollipop_chart(
  full_data, item, 
  "Very few user click on a further google page", "% of users who click on a further google page",
  fun = ~ mean(.!=0, na.rm =TRUE),
  nudge_x = .001, digits = 2)

save_plot(plots[[item]], item)
```


## Seconds to complete search task

```{r}
item <- "Seconds to complete search task"

# full_data %>%
#   group_by_at(item) %>%
#   summarize(n = n()) %>%
#   ggplot(aes(!!sym(item), n)) +
#   geom_point() +
#   geom_line() +
#   ggtitle("raw chart")

# quantile data with labels

plots[[item]] <- quantile_chart(
  full_data, item,
  "On average a user takes 1 min 16 seconds to complete a search",
  "time (seconds)", "% of users who complete the task before time",
  meanlab = "Average : %s sec", qlab = "%s%% complete before %s sec",
  xmax = 250, nudge_x = 8
)

save_plot(plots[[item]], item)

item2 <- paste0(item, "_2")
plots[[item2]] <- lollipop_chart(
  full_data, item, 
  "Depending on the query the search takes an average tome of 45 sec to 1 min 30", "time (seconds)",
  fun = ~ mean(., na.rm =TRUE),
  percent = FALSE,
  nudge_x = 8)

save_plot(plots[[item2]], item2)
```


## Total Clicks

```{r}
item <- "Total Clicks"
table(full_data[[item]], useNA = "always")

plots[[item]] <- quantile_chart(
  full_data, item,
  "Total number of clicks",
  "time (seconds)", "% of users who clicked less than this amount",
  meanlab = "Average : %s times", qlab = "%s%% click %s times or less",
  xmax = 30, nudge_x = 1
)

save_plot(plots[[item]], item)

save_plot(plots[[item]], item)

item2 <- paste0(item, "_2")
plots[[item2]] <- lollipop_chart(
  full_data, item, 
  "Average total clicks", "clicks",
  fun = ~ mean(., na.rm =TRUE),
  percent = FALSE,
  nudge_x = .6)

save_plot(plots[[item2]], item2)
```

## correlations

```{r}
data2 <-
  full_data %>%
  na.omit() %>%
  select(-c(1, 2, 3, 5, 9, 10, 11, 12, 13, 14, 15, 16, 17)) %>%
  select(-1) %>%
  select_if(is.numeric) %>%
  setNames(c("modified queries", "bounces", "pages visited", "seconds to complete", "total clicks"))

plots[["correlations"]] <- GGally::ggcorr(
  data2, nbreaks = 8, palette ='RdGy', label = TRUE, label_size = 5, label_color = 'white')
save_plot(plots[["correlations"]], "correlations")
```

# 2. Save Results

For conveniencewe save our list of ggplot objects, though we'll directly
use the pictures in final.Rmd.

```{r}
saveRDS(plots, here::here("proc_data/plots.RDS"))
```



